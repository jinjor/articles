---
title: E2E テストの同時実行が可能な環境を構築した話
emoji: "▶️"
type: "tech"
topics: ["Playwright"]
publication_name: knowledgework
published: false
---

こんにちは。ナレッジワークの [torii](https://twitter.com/jinjor) です。
ここ最近は E2E テスト基盤の改善に力を入れているので、その一部を紹介します！

# 前提

ナレッジワークでは Playwright を使って E2E テストを書いています。
テストは開発環境で実行しており、毎朝 CI で実行した結果を Slack に通知する仕組みが構築されています。
また、テストはフロントエンドエンジニアと QA エンジニアが協力して書いています。

# 同時に複数の人が実行できない問題

会社とプロダクトが成長するにしたがって E2E テストの書き手は増えていきましたが、徐々に問題が起こるようになりました。
複数の人が同時にテストを実行すると、テスト同士が干渉しあってテストが落ちてしまう問題です。

（製品としての）ナレッジワークは B2B の SaaS であり、お客様（組織）ごとにテナントを分けて提供しています。
当時、開発環境には E2E 用のテナントが２つ用意されており、E2E テストはこのテナントをターゲットに実行されていました。
ここで、もし１つのテナントで２人の人が同時にテストを行ったらどうなるでしょうか？
片方の実行でデータが作成され、もう片方の実行でそのデータが削除される...といったことが起きてテストが落ちてしまうのです。

この干渉を避けるため、日々 Slack で「誰か今 E2E テストを実行していますか？」「実行中なのでもう少し待ってください！」というやり取りが行われている状況でした。
とても効率が悪いし、ストレスも溜まりますね。
そして、将来的にはデプロイのフローの中でも積極的に E2E を流す予定があり、この問題がさらに大きくなることが予想されました。

# 「テナントプール」というアイデア

ここから解決策の話になるのですが、まず没案を潰しておきましょう。

- 動的にテナントを作成して実行する: 作成に時間がかかる＋手動の設定が必要なため NG
- 人数（\* 並列実行数）分テナントを作成して自分のテナントを使うようにする: 大量のテナントを作成するのが手間なため NG

最終的に、「テナントプール」という仕組みを考案して実装することにしました。

![テナントプールの仕組み](/images/e2e-tenant-pool/filter-comparison.png)

仕組みはざっくり以下の通りです。

- あらかじめある程度の数のテナントを作成してテストが実行可能な状態にしておく
- テスト実行時に使用可能なテナントを自動で選択する
- テスト実行中はテナントをロックしておき、終了時にロックを解除する

DB のコネクションプール等と同じ仕組みと思えば理解しやすいかと思います。
実装としては、 `playwright` コマンドの実行前にテナントを選択するコードを挟みます。

```typescript
const TARGET_TENANT = await $`pnpm exec choose-tenant.ts`; // ここで使用可能なテナントを選ぶ

await $`TARGET_TENANT=${TARGET_TENANT} pnpm exec playwright ...`;
```

最初は shell で書いていたのですが、途中で zx が便利だと教えてもらいました（感謝）。

# テナントプール構築までの道のり

仕組みは３行で説明できるほど簡単なのですが、実装と新方式への移行は考えることが結構ありました。
ここからはひたすら苦労話をしていこうと思います（笑）

## テナントのセットアップ手順をドキュメント化

テナントプールに十分な量のテナントを用意するため、テスト用のテナント作成に必要な手順を調べる必要がありました。
テナント作成自体は管理画面からすぐに出来るのですが、作成さえすればすぐにテスト出来るわけではなく、以下のような作業が併せて必要でした。

- 有効にするプランを正しく設定する
- テストに必要なユーザーを追加する
- ユーザーにライセンスを割り当てる
- 常に有効にしたいオプション機能を ON にしておく
- 外部サービスとの連携を済ませておく
- その他

幸いなことに、元々テスト中に使用したデータは global-teardown で全て削除する構成にはなっていたので、テナントに存在するデータに強く依存しているということはありませんでした。
とはいえ、中には上述のような事前条件を必要とする場合もありました。

難しかったのは、どこに暗黙の前提が隠れているのかが難しかったことです。
そこで、プロダクトの各領域に詳しい人が集まって何度もテストを実行しながら地道に前提条件を洗い出して、セットアップ方法をドキュメント化しました（大変感謝）。

## セットアップ手順の半自動化

次に、上記でドキュメント化したセットアップ手順を可能な限り自動化していきました。
と言っても、全てを自動化するのは難しかったので「半自動化」という手段を取ることにしました。

例えば、外部サービス連携では多要素認証が必要になった時、認証部分だけ手動で突破して残りは自動でやりたいことがありました。
そのような場合、 `page.pause()` を使うと、実行を一時停止して手動ステップを挟むことができます。

```typescript
// テスト用のアカウントでログインしてください
// 完了したら |> を押してください。
await page.pause();
```

連携するサービスによっては画像認証などが気まぐれに出現することがあり、 `page.pause()` を正確に実行するのにも苦労しました。

## 正しくセットアップできているかをチェックする

テナントプールでは空いているテナントがランダムで選ばれるため、全てのテナントが全く同じように振る舞うことが重要です。
ここを曖昧にしておくとテナントプール自体の信頼性が落ちてしまいます。

しかし上で見たように手動のプロセスもいくつか入っているため、 global-setup でテナントが正しくセットアップできているかをチェックすることにしました。

## ロック機構の実装

テナントをロックするための専用の API を実装してもよかったのですが、そこまでする必要もないと思ったので既存機能を使ってロックを実現しました。
具体的に言うと、テナント選択時に `tenantlock` という名前のリソースを作成して、テスト実行後にそれを削除します。
このリソースを作成する API は「同名のリソースがあった場合はエラーを返す」という都合の良い性質があり、ほぼ同時に実行しても上手く動作してくれました。

難しかったのは、テスト実行を中断した時にロックしっぱなしになったことです。
実行中にターミナルで Ctrl+C を入力した時に `SIGINT` をトラップしたりしなかったりしたのと、上手くトラップ出来たとしてもそこで非同期処理を実行できないという困難がありました。

```typescript
process.on("SIGINT", () => {
  // ここで大したことはできない
});
```

この問題は未だ解決できていないため、一旦以下の方法で回避しています。

- `tenantlock` を作成したのが自分自身であると推定できる場合はロックを無視する
- `tenantlock` が作成されてから１時間以上経っている場合はロックを無視する（現状テストは１時間以内に終わる想定のため）
- ロック解除して問題ないという確信があれば `tenantlock` を手動で消しても OK

## その他の工夫

プール内のテナントは全て平等であるため、名目上はどのテナントで実行しているのか意識しなくて良いことになっています。
とはいえ、何かの拍子に特定のテナントだけ別の動きをするようになることがないとは言えません。

そこで、 CI から Slack への通知にどのテナントが選ばれたかを表示し、実行オプションとして特定のテナントを指定して実行することができるようにしました。

# 結果

以上の対策により、現在は無事に干渉なく E2E テストを実行できるようになりました。
現在は開発環境で 4 つのテスト用テナントが稼働しています。
テナント作成手順も多くの部分を自動化したため、他のメンバーも安全にテナントを作成できるようになりました。

ただ、移行直後は今までの癖で「今から E2E 実行します〜」という声がたまに聞こえてきたりしました（笑）

# 最後に

この記事の内容の一部は、ナレッジワークの社外向け勉強会 [Encraft #18 Frontend のテスト全部知る 〜Unit Test から E2E まで〜](https://zenn.dev/knowledgework/articles/1f97484327fb51)（開催レポート）でも話しているので、興味があればそちらもご覧ください。
この時（9/20）は「そろそろ完成します！」と言っていましたが、気づけば 12 月になってしまいました。
何はともあれ形になってなってホッとしています。
設計から実装まで丁寧にレビューしてくれた同僚に感謝です！

---

【募集】現在[エンジニア積極採用中](https://kwork.studio/recruit-engineer)です！興味を持たれた方、是非カジュアル面談でお会いしましょう。
